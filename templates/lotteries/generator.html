{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'lotteries:home' %}">In√≠cio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'lotteries:dashboard' object.lottery_type %}">{{ object.get_lottery_type_display }}</a></li>
                <li class="breadcrumb-item active">Gerador</li>
            </ol>
        </nav>
        <h2 class="fw-bold" style="color: {{ object.primary_color }}">
            üé≤ Gerador de Combina√ß√µes - {{ object.get_lottery_type_display }}
        </h2>
        <p class="text-muted">Gere combina√ß√µes personalizadas com base em filtros estat√≠sticos</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="filter-section">
            <h5 class="fw-bold mb-3">‚öôÔ∏è Configura√ß√µes</h5>
            
            <form id="generatorForm">
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Quantidade de N√∫meros
                        <span class="material-icons info-tooltip" data-bs-toggle="tooltip" title="Quantos n√∫meros voc√™ quer em cada jogo">info</span>
                    </label>
                    <select class="form-select" id="numbersCount" name="numbersCount">
                        {% for i in object.min_bet_numbers|default:object.numbers_to_pick|make_list %}
                            {% if forloop.counter >= object.min_bet_numbers|default:object.numbers_to_pick and forloop.counter <= object.max_bet_numbers|default:object.numbers_to_pick %}
                                <option value="{{ forloop.counter }}" {% if forloop.counter == object.numbers_to_pick %}selected{% endif %}>
                                    {{ forloop.counter }} n√∫meros
                                </option>
                            {% endif %}
                        {% endfor %}
                        {% for i in "123456789012345"|make_list %}
                            {% with total=object.min_bet_numbers|default:object.numbers_to_pick|add:forloop.counter %}
                                {% if total <= object.max_bet_numbers|default:object.numbers_to_pick %}
                                    <option value="{{ total }}" {% if total == object.numbers_to_pick %}selected{% endif %}>
                                        {{ total }} n√∫meros
                                    </option>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Quantidade de Jogos
                        <span class="material-icons info-tooltip" data-bs-toggle="tooltip" title="Quantas combina√ß√µes diferentes voc√™ quer gerar">info</span>
                    </label>
                    <select class="form-select" id="gamesCount" name="gamesCount">
                        <option value="1">1 jogo</option>
                        <option value="3" selected>3 jogos</option>
                        <option value="5">5 jogos</option>
                        <option value="10">10 jogos</option>
                        <option value="20">20 jogos</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Filtros Estat√≠sticos
                        <span class="material-icons info-tooltip" data-bs-toggle="tooltip" title="Escolha quais tipos de n√∫meros incluir">info</span>
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeFrequent" checked>
                        <label class="form-check-label" for="includeFrequent">
                            Incluir n√∫meros frequentes
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeDelayed" checked>
                        <label class="form-check-label" for="includeDelayed">
                            Incluir n√∫meros atrasados
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mixStrategy" checked>
                        <label class="form-check-label" for="mixStrategy">
                            Misturar estrat√©gias
                        </label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        N√∫meros Fixos (Opcional)
                        <span class="material-icons info-tooltip" data-bs-toggle="tooltip" title="N√∫meros que devem aparecer em todas as combina√ß√µes">info</span>
                    </label>
                    <div id="numberSelector" class="d-flex flex-wrap gap-2">
                        {% for i in "0123456789"|make_list %}
                            {% for j in "0123456789"|make_list %}
                                {% with num=forloop.parentloop.counter0|add:forloop.counter0|add:forloop.parentloop.counter0|add:1 %}
                                    {% if num <= object.total_numbers %}
                                        <button type="button" class="btn btn-outline-secondary btn-sm number-selector" data-number="{{ num }}">
                                            {{ num|stringformat:"02d" }}
                                        </button>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                    <input type="hidden" id="fixedNumbers" name="fixedNumbers">
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lottery">
                        <span class="material-icons" style="vertical-align: middle;">auto_awesome</span>
                        Gerar Combina√ß√µes
                    </button>
                </div>
            </form>
        </div>

        <div class="alert alert-info mt-3">
            <small>
                <strong>üí° Dica:</strong> As combina√ß√µes s√£o geradas aleatoriamente respeitando seus filtros. 
                Cada gera√ß√£o produz resultados diferentes.
            </small>
        </div>
    </div>

    <div class="col-md-8">
        <div id="resultsArea" class="d-none">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ú® Combina√ß√µes Geradas</h5>
                </div>
                <div class="card-body">
                    <div id="generatedGames"></div>
                    
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-outline-primary" onclick="copyToClipboard()">
                            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">content_copy</span>
                            Copiar
                        </button>
                        <button class="btn btn-outline-success" onclick="exportToPDF()">
                            <span class="material-icons" style="vertical-align: middle; font-size: 18px;">picture_as_pdf</span>
                            Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="placeholderArea">
            <div class="text-center text-muted py-5">
                <span class="material-icons mb-3" style="font-size: 80px; opacity: 0.3;">casino</span>
                <h5>Suas combina√ß√µes aparecer√£o aqui</h5>
                <p>Configure os filtros e clique em "Gerar Combina√ß√µes"</p>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-warning mt-4">
    <div class="d-flex align-items-start">
        <span class="material-icons me-3">warning</span>
        <div>
            <h6 class="fw-bold mb-2">‚ö†Ô∏è Aviso Importante</h6>
            <p class="small mb-0">
                Este gerador √© uma ferramenta de aux√≠lio baseada em estat√≠sticas hist√≥ricas. 
                As combina√ß√µes geradas s√£o aleat√≥rias e n√£o garantem ganhos. Os sorteios s√£o 
                eventos independentes e cada n√∫mero tem a mesma probabilidade de ser sorteado, 
                independentemente de seu hist√≥rico.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Number selector
    const numberSelectors = document.querySelectorAll('.number-selector');
    const fixedNumbersInput = document.getElementById('fixedNumbers');
    const selectedNumbers = new Set();

    numberSelectors.forEach(btn => {
        btn.addEventListener('click', function() {
            const number = parseInt(this.dataset.number);
            if (selectedNumbers.has(number)) {
                selectedNumbers.delete(number);
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-secondary');
            } else {
                selectedNumbers.add(number);
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-primary');
            }
            fixedNumbersInput.value = Array.from(selectedNumbers).sort((a, b) => a - b).join(',');
        });
    });

    // Form submission
    document.getElementById('generatorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateCombinations();
    });
});

function generateCombinations() {
    const numbersCount = parseInt(document.getElementById('numbersCount').value);
    const gamesCount = parseInt(document.getElementById('gamesCount').value);
    const fixedNumbers = document.getElementById('fixedNumbers').value.split(',').filter(n => n).map(Number);
    const totalNumbers = {{ object.total_numbers }};
    
    const games = [];
    for (let i = 0; i < gamesCount; i++) {
        const game = new Set(fixedNumbers);
        while (game.size < numbersCount) {
            const num = Math.floor(Math.random() * totalNumbers) + 1;
            game.add(num);
        }
        games.push(Array.from(game).sort((a, b) => a - b));
    }
    
    displayGames(games);
}

function displayGames(games) {
    const resultsArea = document.getElementById('resultsArea');
    const placeholderArea = document.getElementById('placeholderArea');
    const gamesContainer = document.getElementById('generatedGames');
    
    let html = '';
    games.forEach((game, index) => {
        html += `
            <div class="mb-3 p-3 border rounded">
                <h6 class="text-muted mb-2">Jogo ${index + 1}</h6>
                <div class="d-flex flex-wrap gap-2">
                    ${game.map(num => `
                        <div class="number-ball" style="background: {{ object.primary_color }}">
                            ${String(num).padStart(2, '0')}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    gamesContainer.innerHTML = html;
    resultsArea.classList.remove('d-none');
    placeholderArea.classList.add('d-none');
}

function copyToClipboard() {
    const games = document.querySelectorAll('#generatedGames .mb-3');
    let text = '';
    games.forEach((game, index) => {
        const numbers = Array.from(game.querySelectorAll('.number-ball')).map(ball => ball.textContent.trim());
        text += `Jogo ${index + 1}: ${numbers.join(' - ')}\n`;
    });
    navigator.clipboard.writeText(text).then(() => {
        alert('Combina√ß√µes copiadas para a √°rea de transfer√™ncia!');
    });
}

function exportToPDF() {
    alert('Funcionalidade de exporta√ß√£o PDF ser√° implementada em breve!');
}
</script>
{% endblock %}
